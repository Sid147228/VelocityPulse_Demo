{% extends "base.html" %}

{% block content %}
{% set is_pdf = is_pdf|default(false) %}

<style>
  .subtext { color: #555; margin-bottom: 10px; }
  .report-meta p { margin: 4px 0; }
  .rag { font-weight: bold; padding: 2px 6px; border-radius: 4px; color: #fff; }
  .rag-green { background-color: #28a745; }
  .rag-amber { background-color: #ffc107; color: #000; }
  .rag-red { background-color: #dc3545; }
  table { width: 100%; border-collapse: collapse; margin-top: 12px; }
  th, td { padding: 8px; border-bottom: 1px solid #ddd; text-align: center; }
  .alert { margin: 10px 0; padding: 10px; border: 1px solid #ffeeba; background-color: #fff3cd; color: #856404; border-radius: 4px; }
  .graph-section { margin-top: 30px; }
  /* ✅ Explicit height for charts */
  .graph-section canvas {
    width: 100% !important;
    height: 320px !important;
    margin: 12px 0;
  }
  .graph-section img { max-width: 100%; height: auto; margin: 12px 0; }
  .section { margin-top: 24px; }
</style>

<h1>Test Report</h1>
<h2>Report summary</h2>
<p class="subtext">Customized performance report based on selected transactions and SLA thresholds.</p>

<div class="report-meta">
  <p><strong>Report name:</strong> {{ report_name if report_name else (file_name if file_name else 'Untitled Report') }}</p>
  <p><strong>Overall RAG status:</strong>
    {% if rag_result == 'RED' %}
      <span class="rag rag-red">RED</span>
    {% elif rag_result == 'AMBER' %}
      <span class="rag rag-amber">AMBER</span>
    {% elif rag_result == 'GREEN' %}
      <span class="rag rag-green">GREEN</span>
    {% else %}
      <span class="rag">UNKNOWN</span>
    {% endif %}
  </p>
  <div class="meta">
    <div><strong>RAG basis:</strong> {{ rag_basis }}</div>
    <div><strong>Green SLA:</strong> {{ green_sla }}s</div>
    <div><strong>Amber SLA:</strong> {{ amber_sla }}s</div>
  </div>
  <p><strong>Test date:</strong> {{ test_date or 'Not available' }}</p>
  <p><strong>Test period:</strong> {{ test_period or 'Not available' }}</p>
  <p><strong>Total duration:</strong> {{ total_duration or 'Not available' }}</p>
  <p><strong>Concurrent users:</strong> {{ concurrent_users if concurrent_users is not none else 'Not available' }}</p>
  <p><strong>Steady state:</strong> {{ steady_state or 'Not available' }}</p>
</div>

{% set metric_labels = {'avg':'Average (s)','p90':'P90 (s)','p95':'P95 (s)','samples':'Samples','error':'Error %'} %}

<div class="section">
  <h3>Transaction summary</h3>
  {% if summary|length == 0 %}
    <div class="alert"><strong>Heads up:</strong> No transaction summary data to display.</div>
  {% else %}
    <table>
      <thead>
        <tr>
          <th>Transaction</th>
          {% for metric in metrics_selected %}
            <th>{{ metric_labels.get(metric, metric|capitalize) }}</th>
          {% endfor %}
          <th>RAG</th>
        </tr>
      </thead>
      <tbody>
        {% for row in summary %}
        <tr>
          <td>{{ row.get("Transaction") }}</td>
          {% for metric in metrics_selected %}
            <td>
              {% if row.get(metric) is not none %}
                {% if metric in ['avg','p90','p95'] %}
                  {{ "%.2f"|format(row.get(metric)|float) }}
                {% else %}
                  {{ row.get(metric) }}
                {% endif %}
              {% else %}—{% endif %}
            </td>
          {% endfor %}
          <td>
            {% if row.get("RAG") == 'RED' %}
              <span class="rag rag-red">RED</span>
            {% elif row.get("RAG") == 'AMBER' %}
              <span class="rag rag-amber">AMBER</span>
            {% elif row.get("RAG") == 'GREEN' %}
              <span class="rag rag-green">GREEN</span>
            {% else %}
              <span class="rag">—</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}
</div>

<div class="section">
  <h3>RAG distribution</h3>
  {% set total_rag = (rag_counts['GREEN'] + rag_counts['AMBER'] + rag_counts['RED']) %}
  {% if total_rag == 0 %}
    <div class="alert">No RAG data available.</div>
  {% else %}
    <img src="data:image/png;base64,{{ rag_pie_img }}" alt="RAG distribution">
  {% endif %}
</div>

<div class="graph-section">
  <h3>Performance graphs</h3>
  {% if chart_time_labels|length == 0 %}
    <div class="alert">
      <strong>Note:</strong> No time-series data available for graphs. Showing static fallbacks.
    </div>
    <img src="data:image/png;base64,{{ graph_img }}" alt="Response Time Distribution">
    <img src="data:image/png;base64,{{ txn_progress_img }}" alt="Transaction Progress">
  {% else %}
    {% for metric in metrics_selected %}
      <canvas id="{{ metric }}Chart"></canvas>
    {% endfor %}
    <canvas id="throughputChart"></canvas>
  {% endif %}
</div>

{% if not is_pdf %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const palette = ['#2a5298','#dc3545','#28a745','#ffc107','#17a2b8','#6f42c1','#fd7e14','#20c997','#6610f2','#e83e8c'];

  const timeLabels = {{ chart_time_labels|tojson }};
  const seriesByTxn = {{ series_by_txn|tojson }};
  const selectedMetrics = {{ metrics_selected|tojson }};
  const throughput = {{ series_throughput_over_time|tojson }};
  const metricLabels = {{ metric_labels|tojson }};

  function lineDatasets(seriesByTxn, metric) {
    const txns = Object.keys(seriesByTxn);
    return txns
      .filter(txn => Array.isArray(seriesByTxn[txn][metric]) && seriesByTxn[txn][metric].some(v => v !== null))
      .map((txn, idx) => ({
        label: txn,
        data: seriesByTxn[txn][metric],
        borderColor: palette[idx % palette.length],
        backgroundColor: palette[idx % palette.length],
        tension: 0.2,
        spanGaps: true,
        fill: false
      }));
  }

  if (timeLabels.length > 0) {
    selectedMetrics.forEach(metric => {
      const el = document.getElementById(metric + 'Chart');
      const datasets = lineDatasets(seriesByTxn, metric);
      if (el && datasets.length > 0) {
        new Chart(el, {
          type: 'line',
          data: { labels: timeLabels, datasets },
          options: {
            plugins: { title: { display: true, text: metricLabels[metric] + ' by transaction' } },
            interaction: { mode: 'nearest', intersect: false },
            responsive: true,
            maintainAspectRatio: false
          }
        });
      } else if (el) {
        el.insertAdjacentHTML('beforebegin', `<div class="alert">No data for ${metricLabels[metric]} chart.</div>`);
      }
    });

    const tp = document.getElementById('throughputChart');
    if (tp && Array.isArray(throughput) && throughput.some(v => v !== null && v !== 0)) {
      new Chart(tp, {
        type: 'line',
        data: {
          labels: timeLabels,
          datasets: [{
            label: 'Throughput (requests/sec)',
            data: throughput,
            borderColor: '#2a5298',
            backgroundColor: '#2a5298',
            fill: true,
            tension: 0.2
          }]
        },
        options: {
          plugins: {
            title: { display: true, text: 'Throughput over time' },
            legend: { position: 'bottom' }
          },
          interaction: { mode: 'nearest', intersect: false },
          responsive: true,
          maintainAspectRatio: false
        }
      });
        } else if (tp) {
      tp.insertAdjacentHTML('beforebegin', `<div class="alert">No throughput data available.</div>`);
    }
  }
</script>
{% endif %}
{% endblock %}